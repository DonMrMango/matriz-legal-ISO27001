<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Matriz Legal INSOFT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #0f172a;
            color: #e2e8f0;
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .success-metric {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(21, 128, 61, 0.1) 100%);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .warning-metric {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        
        .error-metric {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(185, 28, 28, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .chart-container {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
    </style>
</head>
<body class="min-h-screen">
    <div x-data="adminDashboard()" x-init="init()">
        <!-- Header -->
        <div class="glass-card rounded-none border-x-0 border-t-0 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-white">Admin Dashboard</h1>
                    <p class="text-slate-400">Matriz Legal INSOFT - Monitoreo y Analytics</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-slate-300">En vivo</span>
                    </div>
                    <select x-model="timeRange" @change="loadAllData()" class="bg-slate-700 border border-slate-600 rounded px-3 py-1 text-sm">
                        <option value="1">Última hora</option>
                        <option value="6">Últimas 6 horas</option>
                        <option value="24">Últimas 24 horas</option>
                        <option value="168">Última semana</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Authentication -->
        <div x-show="!isAuthenticated" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="glass-card rounded-lg p-8 max-w-md w-full mx-4">
                <h2 class="text-xl font-bold text-white mb-4">Autenticación de Administrador</h2>
                <div class="space-y-4">
                    <input 
                        type="password" 
                        x-model="authToken" 
                        placeholder="Token de acceso"
                        @keyup.enter="authenticate()"
                        class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded text-white"
                    >
                    <button 
                        @click="authenticate()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-medium"
                    >
                        Acceder
                    </button>
                    <p x-show="authError" class="text-red-400 text-sm" x-text="authError"></p>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div x-show="isAuthenticated" class="p-6 space-y-6">
            <!-- Realtime Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="metric-card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-400 text-sm">Sesiones Activas</p>
                            <p class="text-2xl font-bold text-white" x-text="realtimeData.active_sessions || 0"></p>
                        </div>
                        <i class="fas fa-users text-blue-400 text-2xl"></i>
                    </div>
                </div>
                
                <div class="success-metric rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-400 text-sm">Consultas Recientes</p>
                            <p class="text-2xl font-bold text-white" x-text="realtimeData.recent_queries || 0"></p>
                        </div>
                        <i class="fas fa-comments text-green-400 text-2xl"></i>
                    </div>
                </div>
                
                <div class="warning-metric rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-400 text-sm">Vistas Recientes</p>
                            <p class="text-2xl font-bold text-white" x-text="realtimeData.recent_views || 0"></p>
                        </div>
                        <i class="fas fa-eye text-yellow-400 text-2xl"></i>
                    </div>
                </div>
                
                <div class="metric-card rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-400 text-sm">Tiempo Promedio</p>
                            <p class="text-2xl font-bold text-white" x-text="(overviewData.page_views?.avg_response_time_ms || 0) + 'ms'"></p>
                        </div>
                        <i class="fas fa-clock text-blue-400 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Overview Stats -->
            <div class="glass-card rounded-lg p-6">
                <h2 class="text-xl font-semibold text-white mb-4">Resumen General</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <h3 class="font-medium text-slate-300">Sesiones</h3>
                        <p class="text-lg text-white">Total: <span x-text="overviewData.sessions?.total || 0"></span></p>
                        <p class="text-sm text-slate-400">Recientes: <span x-text="overviewData.sessions?.recent || 0"></span></p>
                    </div>
                    <div class="space-y-2">
                        <h3 class="font-medium text-slate-300">Consultas Chat</h3>
                        <p class="text-lg text-white">Total: <span x-text="overviewData.chat_queries?.total || 0"></span></p>
                        <p class="text-sm text-slate-400">Tokens usados: <span x-text="overviewData.chat_queries?.total_tokens_used || 0"></span></p>
                    </div>
                    <div class="space-y-2">
                        <h3 class="font-medium text-slate-300">Documentos</h3>
                        <p class="text-lg text-white">Promedio encontrados: <span x-text="overviewData.chat_queries?.avg_documents_found || 0"></span></p>
                        <p class="text-sm text-slate-400">Tiempo promedio: <span x-text="(overviewData.chat_queries?.avg_response_time_ms || 0) + 'ms'"></span></p>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Sessions Chart -->
                <div class="chart-container rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Sesiones por Hora</h3>
                    <canvas id="sessionsChart" width="400" height="200"></canvas>
                </div>
                
                <!-- Chat Queries Chart -->
                <div class="chart-container rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Consultas Chat por Hora</h3>
                    <canvas id="chatChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Tables Row -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <!-- Top Documents -->
                <div class="glass-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Documentos Más Consultados</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-slate-600">
                                    <th class="text-left text-slate-300 py-2">Documento</th>
                                    <th class="text-left text-slate-300 py-2">Tipo</th>
                                    <th class="text-right text-slate-300 py-2">Accesos</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="doc in documentData.most_accessed_documents?.slice(0, 10) || []">
                                    <tr class="border-b border-slate-700">
                                        <td class="text-white py-2" x-text="doc.document_title?.substring(0, 40) + '...'"></td>
                                        <td class="text-slate-400 py-2" x-text="doc.document_type"></td>
                                        <td class="text-right text-blue-400 py-2" x-text="doc.access_count"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Query Types -->
                <div class="glass-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Tipos de Consultas</h3>
                    <div class="space-y-3">
                        <template x-for="type in chatData.query_type_stats || []">
                            <div class="flex items-center justify-between p-3 bg-slate-800 rounded">
                                <div>
                                    <p class="text-white font-medium" x-text="type.query_type"></p>
                                    <p class="text-slate-400 text-sm">
                                        Promedio: <span x-text="Math.round(type.avg_response_time_ms || 0)"></span>ms, 
                                        <span x-text="Math.round(type.avg_documents_found || 0)"></span> docs
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold text-blue-400" x-text="type.count"></p>
                                    <p class="text-xs text-slate-500">consultas</p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="glass-card rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4">Actividad Reciente (Últimos 5 minutos)</h3>
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    <template x-for="activity in realtimeData.latest_activity || []">
                        <div class="flex items-center justify-between p-2 bg-slate-800 rounded text-sm">
                            <div class="flex items-center space-x-3">
                                <i class="fas" :class="activity.activity_type === 'chat_query' ? 'fa-comment text-green-400' : 'fa-eye text-blue-400'"></i>
                                <span class="text-white" x-text="activity.details"></span>
                            </div>
                            <span class="text-slate-400" x-text="formatTime(activity.timestamp)"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="glass-card rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-4">Rendimiento por Endpoint</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-slate-600">
                                <th class="text-left text-slate-300 py-2">Endpoint</th>
                                <th class="text-right text-slate-300 py-2">Requests</th>
                                <th class="text-right text-slate-300 py-2">Promedio</th>
                                <th class="text-right text-slate-300 py-2">Min</th>
                                <th class="text-right text-slate-300 py-2">Max</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="endpoint in performanceData.endpoint_performance || []">
                                <tr class="border-b border-slate-700">
                                    <td class="text-white py-2" x-text="endpoint.endpoint"></td>
                                    <td class="text-right text-slate-400 py-2" x-text="endpoint.request_count"></td>
                                    <td class="text-right text-blue-400 py-2" x-text="Math.round(endpoint.avg_response_time || 0) + 'ms'"></td>
                                    <td class="text-right text-green-400 py-2" x-text="(endpoint.min_response_time || 0) + 'ms'"></td>
                                    <td class="text-right text-red-400 py-2" x-text="(endpoint.max_response_time || 0) + 'ms'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        function adminDashboard() {
            return {
                isAuthenticated: false,
                authToken: '',
                authError: '',
                timeRange: '24',
                
                // Data containers
                overviewData: {},
                sessionData: {},
                chatData: {},
                documentData: {},
                performanceData: {},
                realtimeData: {},
                
                // Charts
                sessionsChart: null,
                chatChart: null,
                
                init() {
                    // Check if already authenticated
                    const token = localStorage.getItem('admin_token');
                    if (token) {
                        this.authToken = token;
                        this.authenticate();
                    }
                    
                    // Start realtime updates
                    setInterval(() => {
                        if (this.isAuthenticated) {
                            this.loadRealtimeData();
                        }
                    }, 10000); // Every 10 seconds
                },
                
                async authenticate() {
                    try {
                        const response = await fetch('/api/admin/analytics/overview', {
                            headers: {
                                'Authorization': `Bearer ${this.authToken}`
                            }
                        });
                        
                        if (response.ok) {
                            this.isAuthenticated = true;
                            this.authError = '';
                            localStorage.setItem('admin_token', this.authToken);
                            await this.loadAllData();
                        } else {
                            this.authError = 'Token de acceso inválido';
                        }
                    } catch (error) {
                        this.authError = 'Error de conexión';
                    }
                },
                
                async loadAllData() {
                    if (!this.isAuthenticated) return;
                    
                    try {
                        await Promise.all([
                            this.loadOverviewData(),
                            this.loadSessionData(),
                            this.loadChatData(),
                            this.loadDocumentData(),
                            this.loadPerformanceData(),
                            this.loadRealtimeData()
                        ]);
                        
                        this.updateCharts();
                    } catch (error) {
                        console.error('Error loading data:', error);
                    }
                },
                
                async apiCall(endpoint) {
                    const response = await fetch(`${endpoint}?hours=${this.timeRange}`, {
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.success ? data.data : {};
                },
                
                async loadOverviewData() {
                    this.overviewData = await this.apiCall('/api/admin/analytics/overview');
                },
                
                async loadSessionData() {
                    this.sessionData = await this.apiCall('/api/admin/analytics/sessions');
                },
                
                async loadChatData() {
                    this.chatData = await this.apiCall('/api/admin/analytics/chat');
                },
                
                async loadDocumentData() {
                    this.documentData = await this.apiCall('/api/admin/analytics/documents');
                },
                
                async loadPerformanceData() {
                    this.performanceData = await this.apiCall('/api/admin/analytics/performance');
                },
                
                async loadRealtimeData() {
                    try {
                        this.realtimeData = await this.apiCall('/api/admin/analytics/realtime');
                    } catch (error) {
                        console.error('Error loading realtime data:', error);
                    }
                },
                
                updateCharts() {
                    this.updateSessionsChart();
                    this.updateChatChart();
                },
                
                updateSessionsChart() {
                    const ctx = document.getElementById('sessionsChart');
                    if (!ctx) return;
                    
                    if (this.sessionsChart) {
                        this.sessionsChart.destroy();
                    }
                    
                    const data = this.sessionData.sessions_by_hour || [];
                    
                    this.sessionsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(d => new Date(d.hour).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })),
                            datasets: [{
                                label: 'Sesiones',
                                data: data.map(d => d.session_count),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#e2e8f0' }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                },
                                y: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                }
                            }
                        }
                    });
                },
                
                updateChatChart() {
                    const ctx = document.getElementById('chatChart');
                    if (!ctx) return;
                    
                    if (this.chatChart) {
                        this.chatChart.destroy();
                    }
                    
                    const data = this.chatData.queries_by_hour || [];
                    
                    this.chatChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(d => new Date(d.hour).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })),
                            datasets: [{
                                label: 'Consultas',
                                data: data.map(d => d.query_count),
                                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                                borderColor: '#22c55e',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#e2e8f0' }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                },
                                y: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                                }
                            }
                        }
                    });
                },
                
                formatTime(timestamp) {
                    return new Date(timestamp).toLocaleTimeString('es-ES');
                }
            }
        }
    </script>
</body>
</html>